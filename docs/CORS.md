# CORS Configuration Guide

## Что такое CORS?

CORS (Cross-Origin Resource Sharing) - механизм безопасности браузера, который контролирует доступ к API с разных доменов.

## Как настроено в проекте

В данном проекте CORS настроен с:

- Белым списком доменов из переменной окружения `CORS_ORIGINS`
- Поддержкой режима development (разрешены все источники)
- Кэшированием preflight-запросов на 24 часа (86400 секунд)
- Поддержкой credentials для работы с cookies
- Разрешенными методами: GET, POST, PUT, PATCH, DELETE, OPTIONS
- Разрешенными заголовками: Content-Type, Authorization, X-Requested-With

## Настройка для разных сценариев

### 1. Локальная разработка (один разработчик)

```
CORS_ORIGINS="http://localhost:5173,http://localhost:3000"
NODE_ENV="development"
```

### 2. Команда разработчиков из разных городов

```
CORS_ORIGINS="*"
NODE_ENV="development"
```

### 3. Тестовый деплой

```
CORS_ORIGINS="https://test-app.example.com,https://staging.example.com"
NODE_ENV="testing"
```

### 4. Продакшн

```
CORS_ORIGINS="https://app.example.com,https://admin.example.com"
NODE_ENV="production"
```

## Решение частых проблем

1. **"Каждый час появляются ошибки CORS"**

   - Причина: Каждый браузер кэширует preflight-запросы (OPTIONS), кэш может истекать
   - Решение: Теперь кэширование установлено на 24 часа (было 1 час или меньше)

2. **Фронтенд-разработчик не может подключиться к API**

   - Простое решение для development: установите `CORS_ORIGINS="*"`
   - Для production: добавьте домен разработчика в список `CORS_ORIGINS`
   - Узнайте полный URL фронтенда: например, `http://192.168.1.100:5173` или `https://dev-john.example.com`

3. **CORS ошибки с учетными данными/cookies**

   - Решение: Включена опция `credentials: true`
   - Важно: При использовании cookies нельзя использовать `origin: "*"`, нужны конкретные домены

4. **CORS для Postman и серверных запросов**

   - CORS применяется только в браузерах
   - Postman и серверные запросы всегда работают независимо от CORS

5. **Отладка CORS ошибок**
   - Смотрите консоль браузера для точного сообщения об ошибке
   - Смотрите логи сервера: все заблокированные запросы логируются с `console.warn`
   - Временно включите `CORS_ORIGINS="*"` для тестирования
   - Используйте инструменты разработчика для проверки заголовков ответа

## Как работают настройки в коде

1. Если `CORS_ORIGINS="*"` или не задан, разрешаются все источники
2. Если `NODE_ENV="development"` или не задан, тоже разрешаются все источники
3. Только если `NODE_ENV="production"` и задан `CORS_ORIGINS` со списком доменов, происходит строгая проверка
